<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>LODISNA – Transport Operations Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="LODISNA-inspired transport operations simulator: 5 Spanish-plated trucks, international drivers, incidents, KPI donuts, interactive charts, and a simplified European route map." />

<style>
  :root{
    --bg1:#f6f8ff; --bg2:#ffffff; --card:#ffffff;
    --text:#0f172a; --muted:rgba(15,23,42,.68);
    --border:rgba(15,23,42,.12); --shadow:0 18px 40px rgba(15,23,42,.10);
    --blue:#2563eb; --red:#ef4444; --radius:18px; --max:1140px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1000px 650px at 10% 10%, rgba(37,99,235,.15), transparent 60%),
      radial-gradient(900px 650px at 90% 10%, rgba(239,68,68,.14), transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    line-height:1.5;
  }
  .container{max-width:var(--max);margin:0 auto;padding:22px}
  a{color:inherit;text-decoration:none}
  a:hover{text-decoration:underline}

  .top{
    position:sticky;top:0;z-index:50;
    background:rgba(255,255,255,.88);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--border);
  }
  .top-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:-.3px}
  .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--blue),var(--red));box-shadow:0 0 0 5px rgba(37,99,235,.12)}
  .sub{color:var(--muted);font-weight:800;font-size:.95rem;margin-top:2px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  h1{margin:0 0 8px;font-size:clamp(1.9rem,3vw,2.6rem);letter-spacing:-.9px;line-height:1.1}
  h2{margin:0 0 10px;letter-spacing:-.4px}
  h3{margin:0 0 8px;letter-spacing:-.3px}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:12px 14px;border-radius:14px;border:1px solid var(--border);
    background:rgba(255,255,255,.85);font-weight:950;cursor:pointer;
    box-shadow:0 12px 26px rgba(15,23,42,.10);user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .btn:hover{background:rgba(15,23,42,.02);border-color:rgba(15,23,42,.18);text-decoration:none}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,rgba(37,99,235,1),rgba(37,99,235,.82));border-color:rgba(37,99,235,.35);color:#fff}
  .btn.small{padding:9px 12px;border-radius:12px;font-size:.95rem}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.02);font-weight:950;font-size:.88rem;color:rgba(15,23,42,.9);
  }
  .chip.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
  .chip.red{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}

  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
  @media(max-width:980px){.kpis{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.kpis{grid-template-columns:1fr}}
  .kpi{border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.02);border-radius:14px;padding:12px}
  .kpi .k{color:rgba(15,23,42,.72);font-weight:950;font-size:.9rem}
  .kpi .v{font-weight:950;font-size:1.15rem;margin-top:6px}

  .searchRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .searchRow input{
    flex:1 1 320px;padding:11px 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.16);background:#fff;outline:none;font-weight:800
  }

  .tableWrap{margin-top:12px;border-radius:14px;border:1px solid rgba(15,23,42,.12);overflow:auto;background:#fff}
  table{width:100%;border-collapse:collapse;min-width:1200px}
  th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:.92rem;white-space:nowrap;text-align:left}
  th{position:sticky;top:0;background:#fff;color:rgba(15,23,42,.75);font-weight:950;z-index:2}

  /* Charts */
  .chartControls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px;align-items:end}
  @media(max-width:980px){.chartControls{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.chartControls{grid-template-columns:1fr}}
  .field label{display:block;margin-bottom:6px;font-weight:950;font-size:.9rem;color:rgba(15,23,42,.85)}
  .field select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.16);background:#fff;outline:none;font-weight:800}
  .chartsGrid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px;margin-top:12px}
  @media(max-width:980px){.chartsGrid{grid-template-columns:1fr}}
  .chartCard{border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:14px;padding:12px}
  .chartCanvasWrap{position:relative;height:320px}
  @media(max-width:980px){.chartCanvasWrap{height:300px}}

  /* Donuts bottom */
  .donutGrid{
    display:grid;grid-template-columns:repeat(3,minmax(0,1fr));
    gap:12px;align-items:stretch;margin-top:12px;
  }
  @media(max-width:980px){.donutGrid{grid-template-columns:1fr}}
  .donutCard{
    border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.02);
    border-radius:14px;
    padding:12px;
    display:grid;
    grid-template-columns:140px 1fr;
    gap:12px;
    align-items:center;
  }
  .donutCanvas{width:120px;height:120px;display:block;margin:0 auto}
  .donutText strong{font-weight:950}
  .donutText .muted{font-weight:800}

  /* Map */
  .mapWrap{margin-top:14px;border:1px solid rgba(15,23,42,.12);border-radius:14px;overflow:hidden;background:#fff}
  .mapHeader{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid rgba(15,23,42,.10)}
  .mapCanvas{width:100%;display:block}
</style>
</head>

<body>
<header class="top">
  <div class="container top-inner">
    <div>
      <div class="brand"><span class="dot"></span> LODISNA – Transport Operations (Example)</div>
      <div class="sub">5 Spanish-plated trucks · international drivers · incidents · reporting-ready KPIs</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn" href="index.html">← Back</a>
      <a class="btn small" href="#charts">Charts</a>
      <a class="btn small" href="#map">Map</a>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="row">
      <div>
        <h1>Example of my work at LODISNA</h1>
        <p class="muted" style="margin:6px 0 0">
          Road freight operations example across Europe: double-driver assignments, realistic incidents, and cost/revenue/margin logic.
        </p>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="gen" type="button">Generate dataset</button>
        <button class="btn" id="dl" type="button">Download CSV (Power BI)</button>
      </div>
    </div>

    <div class="searchRow">
      <input id="search" type="text" placeholder="Search driver, incident, pickup, delivery, plate, shipment..." />
      <button class="btn" id="onlyIncidents" type="button">Incidents only</button>
      <button class="btn" id="showAll" type="button">Show all</button>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Shipment</th>
            <th>Date</th>
            <th>Truck Plate (ES)</th>
            <th>Trailer Plate (ES)</th>
            <th>Driver 1</th>
            <th>Driver 2</th>
            <th>Pickup</th>
            <th>Delivery</th>
            <th>KM</th>
            <th>Status</th>
            <th>Incident</th>
            <th>Revenue</th>
            <th>Cost</th>
            <th>Margin</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Charts -->
    <div id="charts" style="margin-top:18px">
      <div class="row">
        <h2 style="margin:0">Interactive Reporting (Charts)</h2>
        <span class="chip blue">line + bar</span>
      </div>
      <p class="muted" style="margin:10px 0 0">
        Power BI-like analysis: trends over time (line chart) and performance by truck (bar chart).
      </p>

      <div class="chartControls">
        <div class="field">
          <label>Granularity</label>
          <select id="gran">
            <option value="month" selected>Month</option>
            <option value="day">Day</option>
            <option value="year">Year</option>
          </select>
        </div>
        <div class="field">
          <label>Trend metric</label>
          <select id="trendMetric">
            <option value="revenue" selected>Revenue</option>
            <option value="cost">Cost</option>
            <option value="margin">Margin</option>
            <option value="onTimeRate">On-time rate (%)</option>
            <option value="incidentRate">Incident rate (%)</option>
          </select>
        </div>
        <div class="field">
          <label>Bar metric (by truck)</label>
          <select id="barMetric">
            <option value="margin" selected>Total margin</option>
            <option value="revenue">Total revenue</option>
            <option value="cost">Total cost</option>
            <option value="shipments">Shipments count</option>
            <option value="incidentCount">Incidents count</option>
          </select>
        </div>
        <div class="field">
          <label>Downloads</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn small" id="dlTrendPng" type="button">Trend PNG</button>
            <button class="btn small" id="dlBarPng" type="button">Bar PNG</button>
          </div>
        </div>
      </div>

      <div class="chartsGrid">
        <div class="chartCard">
          <div class="row">
            <h3 style="margin:0">Trend over time</h3>
            <span class="chip">time series</span>
          </div>
          <div class="chartCanvasWrap"><canvas id="trendChart"></canvas></div>
          <p class="muted" style="margin:10px 0 0">Useful for: monthly margin trend, incident spikes, seasonal volume.</p>
        </div>

        <div class="chartCard">
          <div class="row">
            <h3 style="margin:0">By truck (fleet view)</h3>
            <span class="chip red">operations</span>
          </div>
          <div class="chartCanvasWrap"><canvas id="barChart"></canvas></div>
          <p class="muted" style="margin:10px 0 0">Useful for: identifying best-performing units and risk (incidents).</p>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="mapWrap">
      <div class="mapHeader">
        <div>
          <h2 style="margin:0">European Route Map (simplified)</h2>
          <p class="muted" style="margin:6px 0 0">Nodes and links derived from the dataset (no external map API).</p>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small" id="dlMapPng" type="button">Map PNG</button>
        </div>
      </div>
      <canvas id="routeMap" width="1100" height="480" class="mapCanvas"></canvas>
    </div>

    <!-- Donuts bottom -->
    <div style="margin-top:16px">
      <div class="row">
        <h2 style="margin:0">Operational KPIs (Donuts)</h2>
        <span class="chip blue">quick view</span>
      </div>
      <div class="donutGrid" id="donutGrid"></div>
      <p class="muted" style="margin:10px 0 0">Quick interpretation: on-time performance, incident rate, and margin index.</p>
    </div>

  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const $ = (id) => document.getElementById(id);
  const eur = (n) => "€" + (Number.isFinite(n)?n:0).toFixed(2);

  function mulberry32(seed){
    let a = seed >>> 0;
    return function(){
      a += 0x6D2B79F5;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  const pad = (n, w=4) => String(n).padStart(w,"0");
  const iso = (d) => d.toISOString().slice(0,10);
  const addDays = (isoDate, n) => { const d=new Date(isoDate); d.setDate(d.getDate()+n); return iso(d); };

  const DRIVERS = [
    {name:"Aisha Khan", phone:"+44 7700 900221"},
    {name:"Noah Johnson", phone:"+1 415 555 0129"},
    {name:"Marek Nowak", phone:"+48 601 332 911"},
    {name:"Giulia Bianchi", phone:"+39 347 221 880"},
    {name:"Radu Ionescu", phone:"+40 721 456 700"},
    {name:"Yuki Tanaka", phone:"+81 70 1234 7788"},
    {name:"Omar Haddad", phone:"+971 50 712 3311"},
    {name:"Liam O'Connor", phone:"+353 86 234 7701"},
    {name:"Sofia Petrova", phone:"+359 88 773 2110"},
    {name:"Lucas Martin", phone:"+33 6 12 99 84 41"}
  ];

  const CITIES = ["Madrid","Barcelona","Valencia","Bilbao","Seville","Paris","Lyon","Brussels","Luxembourg","Frankfurt","Cologne","Hamburg","Munich","Milan","Turin","Vienna","Prague","Warsaw","Budapest","Bucharest","Amsterdam","Rotterdam"];
  const INCIDENTS = ["None","Traffic delay","Weather delay","Customs hold","Mechanical issue","Documentation issue","Customer slot missed"];

  function randomSpanishPlate(rnd){
    const letters="BCDFGHJKLMNPRSTVWXYZ";
    const n=Math.floor(1000 + rnd()*9000);
    const a=letters[Math.floor(rnd()*letters.length)];
    const b=letters[Math.floor(rnd()*letters.length)];
    const c=letters[Math.floor(rnd()*letters.length)];
    return `${n}-${a}${b}${c}`;
  }

  function downloadCSV(filename, rows){
    if(!rows || !rows.length){ alert("Please generate data first."); return; }
    const headers = Object.keys(rows[0]);
    const lines = [headers.join(",")];
    for(const r of rows){
      const line = headers.map(h=>{
        const s = String(r[h] ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
        return s;
      }).join(",");
      lines.push(line);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Donut helpers
  function drawDonut(canvas, value01, label, strokeStyle){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)/2 - 10;

    ctx.clearRect(0,0,w,h);

    ctx.lineWidth = 12;
    ctx.lineCap = "round";

    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.stroke();

    const start = -Math.PI/2;
    const end = start + Math.PI*2*Math.max(0, Math.min(1, value01));
    ctx.strokeStyle = strokeStyle;
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end);
    ctx.stroke();

    ctx.fillStyle = "rgba(15,23,42,.92)";
    ctx.font = "900 16px system-ui";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(Math.round(value01*100) + "%", cx, cy-2);

    ctx.fillStyle = "rgba(15,23,42,.65)";
    ctx.font = "800 11px system-ui";
    ctx.fillText(label, cx, cy+16);
  }

  function donutCard(title, value01, label, color, footerText){
    const card = document.createElement("div");
    card.className = "donutCard";
    card.innerHTML = `
      <div><canvas class="donutCanvas" width="120" height="120" aria-label="${title} chart"></canvas></div>
      <div class="donutText">
        <strong>${title}</strong>
        <div class="muted">${footerText}</div>
        <div style="margin-top:10px"><span class="chip">${label}</span></div>
      </div>
    `;
    const c = card.querySelector("canvas");
    drawDonut(c, value01, label, color);
    return card;
  }

  // Dataset
  let ROWS = [];
  let incidentsOnly = false;
  let trendChart = null;
  let barChart = null;

  function groupKey(date, gran){
    if (gran === "day") return date;
    if (gran === "month") return date.slice(0,7);
    return date.slice(0,4);
  }

  function generate(){
    const seed = 97 + Math.floor(Math.random()*9999);
    const rnd = mulberry32(seed);

    const fleet = [];
    for(let i=1;i<=5;i++){
      fleet.push({ truck_plate: randomSpanishPlate(rnd), trailer_plate: randomSpanishPlate(rnd) });
    }

    const horizon = 540;
    const start = (()=>{ const d=new Date(); d.setDate(d.getDate()-horizon); return iso(d); })();

    ROWS = [];
    const nShip = 260;

    for(let i=1;i<=nShip;i++){
      const sh = "SHP-LD-" + pad(i, 5);
      const date = addDays(start, Math.floor(rnd()*horizon));

      const f = fleet[Math.floor(rnd()*fleet.length)];
      const d1 = DRIVERS[Math.floor(rnd()*DRIVERS.length)];
      let d2 = DRIVERS[Math.floor(rnd()*DRIVERS.length)];
      if (d2.name === d1.name) d2 = DRIVERS[(DRIVERS.indexOf(d1)+1) % DRIVERS.length];

      const pickup = CITIES[Math.floor(rnd()*CITIES.length)];
      let delivery = CITIES[Math.floor(rnd()*CITIES.length)];
      while (delivery === pickup) delivery = CITIES[Math.floor(rnd()*CITIES.length)];

      const km = Math.round(320 + rnd()*1550);

      const incident = (rnd()<0.20) ? INCIDENTS[Math.floor(rnd()*INCIDENTS.length)] : "None";
      const delayed = (rnd() < (0.08 + (km>1100?0.08:0))) || incident !== "None";
      const status = delayed ? "Delayed" : "On time";

      const month = Number(date.slice(5,7));
      const seasonFactor = (month>=11 || month<=2) ? 1.08 : (month>=6 && month<=8) ? 1.04 : 1.00;

      const fuelLiters = km * (0.28 + rnd()*0.07);
      const fuelCost = fuelLiters * (1.45 + rnd()*0.45);
      const toll = km * (0.06 + rnd()*0.05);
      const labor = (km/70) * (30 + rnd()*10);
      const overhead = 55 + rnd()*45;

      const cost = (fuelCost + toll + labor + overhead) * seasonFactor;
      const ratePerKm = (1.10 + rnd()*0.35) * seasonFactor;
      const revenue = km * ratePerKm + (rnd()*90);
      const margin = revenue - cost;

      ROWS.push({
        shipment_id: sh,
        date,
        truck_plate: f.truck_plate,
        trailer_plate: f.trailer_plate,
        driver_1: d1.name,
        driver_2: d2.name,
        pickup,
        delivery,
        km,
        status,
        incident,
        revenue: +revenue.toFixed(2),
        cost: +cost.toFixed(2),
        margin: +margin.toFixed(2)
      });
    }

    renderAll();
  }

  function applySearch(rows){
    const q = ($("search").value || "").trim().toLowerCase();
    if(!q) return rows;
    return rows.filter(r => {
      const hay = [
        r.shipment_id, r.date, r.truck_plate, r.trailer_plate,
        r.driver_1, r.driver_2, r.pickup, r.delivery,
        r.status, r.incident
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function computeKPIs(){
    const total = ROWS.length || 1;
    const onTime = ROWS.filter(x => x.status === "On time").length;
    const incidentCount = ROWS.filter(x => x.incident && x.incident !== "None").length;

    const rev = ROWS.reduce((a,x)=>a + x.revenue, 0);
    const cost = ROWS.reduce((a,x)=>a + x.cost, 0);
    const margin = rev - cost;

    const onTimePct = onTime / total;
    const incidentPct = incidentCount / total;

    const marginPerShipment = margin / total;

    return { total, onTime, incidentCount, rev, cost, margin, onTimePct, incidentPct, marginPerShipment };
  }

  function buildTimeSeries(gran, metric){
    const map = new Map();
    for (const r of ROWS){
      const k = groupKey(r.date, gran);
      if (!map.has(k)){
        map.set(k, {key:k, revenue:0, cost:0, margin:0, shipments:0, onTime:0, incidents:0});
      }
      const o = map.get(k);
      o.revenue += r.revenue;
      o.cost += r.cost;
      o.margin += r.margin;
      o.shipments += 1;
      if (r.status === "On time") o.onTime += 1;
      if (r.incident && r.incident !== "None") o.incidents += 1;
    }
    const arr = Array.from(map.values()).sort((a,b)=> a.key.localeCompare(b.key));
    const labels = arr.map(x => x.key);
    const values = arr.map(x => {
      if (metric === "revenue") return +x.revenue.toFixed(2);
      if (metric === "cost") return +x.cost.toFixed(2);
      if (metric === "margin") return +x.margin.toFixed(2);
      if (metric === "onTimeRate") return +(x.shipments ? (x.onTime/x.shipments*100) : 0).toFixed(1);
      if (metric === "incidentRate") return +(x.shipments ? (x.incidents/x.shipments*100) : 0).toFixed(1);
      return 0;
    });
    return { labels, values };
  }

  function buildTruckBars(metric){
    const map = new Map();
    for (const r of ROWS){
      const k = r.truck_plate;
      if (!map.has(k)){
        map.set(k, {truck:k, revenue:0, cost:0, margin:0, shipments:0, incidents:0});
      }
      const o = map.get(k);
      o.revenue += r.revenue;
      o.cost += r.cost;
      o.margin += r.margin;
      o.shipments += 1;
      if (r.incident && r.incident !== "None") o.incidents += 1;
    }
    const arr = Array.from(map.values()).sort((a,b)=> b.margin - a.margin);
    const labels = arr.map(x => x.truck);
    const values = arr.map(x => {
      if (metric === "margin") return +x.margin.toFixed(2);
      if (metric === "revenue") return +x.revenue.toFixed(2);
      if (metric === "cost") return +x.cost.toFixed(2);
      if (metric === "shipments") return x.shipments;
      if (metric === "incidentCount") return x.incidents;
      return 0;
    });
    return { labels, values };
  }

  function renderTable(){
    let rows = ROWS.slice().sort((a,b) => (b.date || "").localeCompare(a.date || ""));
    if (incidentsOnly) rows = rows.filter(x => x.incident && x.incident !== "None");
    rows = applySearch(rows);

    const body = $("tbody");
    body.innerHTML = "";
    rows.slice(0, 220).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.shipment_id}</td>
        <td>${r.date}</td>
        <td>${r.truck_plate}</td>
        <td>${r.trailer_plate}</td>
        <td>${r.driver_1}</td>
        <td>${r.driver_2}</td>
        <td>${r.pickup}</td>
        <td>${r.delivery}</td>
        <td>${r.km}</td>
        <td>${r.status}</td>
        <td>${r.incident}</td>
        <td>${eur(r.revenue)}</td>
        <td>${eur(r.cost)}</td>
        <td>${eur(r.margin)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderKPICardsAndDonuts(){
    const k = computeKPIs();
    $("kpis").innerHTML = `
      <div class="kpi"><div class="k">Shipments</div><div class="v">${k.total}</div></div>
      <div class="kpi"><div class="k">On time</div><div class="v">${k.onTime} (${Math.round(k.onTimePct*100)}%)</div></div>
      <div class="kpi"><div class="k">Incidents</div><div class="v">${k.incidentCount} (${Math.round(k.incidentPct*100)}%)</div></div>
      <div class="kpi"><div class="k">Total margin</div><div class="v">${eur(k.margin)}</div></div>
    `;

    const g = $("donutGrid");
    g.innerHTML = "";
    g.appendChild(donutCard("On-time Performance", k.onTimePct, "On time", "rgba(37,99,235,1)", `${Math.round(k.onTimePct*100)}% on-time shipments`));
    g.appendChild(donutCard("Incident Rate", k.incidentPct, "Incidents", "rgba(239,68,68,1)", `${k.incidentCount} shipments with incidents`));
    g.appendChild(donutCard("Margin Index", Math.max(0, Math.min(1, (k.marginPerShipment / 450))), "Margin", "rgba(15,23,42,.86)", `Avg margin ≈ ${eur(k.marginPerShipment)} / shipment`));
  }

  function renderCharts(){
    const gran = $("gran").value;
    const trendMetric = $("trendMetric").value;
    const barMetric = $("barMetric").value;

    const ts = buildTimeSeries(gran, trendMetric);
    const bars = buildTruckBars(barMetric);

    if (trendChart) trendChart.destroy();
    trendChart = new Chart($("trendChart"), {
      type: "line",
      data: { labels: ts.labels, datasets: [{ label: trendMetric, data: ts.values, tension: 0.25, pointRadius: 2, borderWidth: 2 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true }, tooltip: { mode: "index", intersect: false } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: false } }
      }
    });

    if (barChart) barChart.destroy();
    barChart = new Chart($("barChart"), {
      type: "bar",
      data: { labels: bars.labels, datasets: [{ label: barMetric, data: bars.values, borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
      }
    });
  }

  function downloadChartPng(chart, filename){
    if (!chart){ alert("Generate data first."); return; }
    const a = document.createElement("a");
    a.href = chart.toBase64Image("image/png", 1);
    a.download = filename;
    a.click();
  }

  // Simplified map (nodes)
  const GEO = {
    Madrid:[180,340], Barcelona:[240,330], Valencia:[220,360], Bilbao:[170,300], Seville:[150,380],
    Paris:[360,220], Lyon:[380,250], Brussels:[390,200], Luxembourg:[420,210],
    Frankfurt:[470,220], Cologne:[455,210], Hamburg:[480,170], Munich:[500,260],
    Milan:[470,300], Turin:[450,290], Vienna:[560,250], Prague:[540,230],
    Warsaw:[620,210], Budapest:[590,270], Bucharest:[680,300],
    Amsterdam:[380,180], Rotterdam:[370,185]
  };

  function drawRouteMap(){
    const c = $("routeMap");
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    // Background
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(0,0,c.width,c.height);

    // Subtle grid
    ctx.strokeStyle = "rgba(15,23,42,.08)";
    for(let x=0;x<c.width;x+=110){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,c.height); ctx.stroke(); }
    for(let y=0;y<c.height;y+=90){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(c.width,y); ctx.stroke(); }

    // Routes (top 28 shipments by km)
    const routes = ROWS.slice().sort((a,b)=>b.km-a.km).slice(0,28);

    // draw lines
    routes.forEach(r=>{
      const a = GEO[r.pickup], b = GEO[r.delivery];
      if(!a || !b) return;
      ctx.strokeStyle = (r.incident && r.incident!=="None") ? "rgba(239,68,68,.75)" : "rgba(37,99,235,.75)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(a[0], a[1]);
      ctx.lineTo(b[0], b[1]);
      ctx.stroke();
    });

    // nodes
    Object.entries(GEO).forEach(([city,xy])=>{
      const x=xy[0], y=xy[1];
      ctx.fillStyle = "rgba(15,23,42,.86)";
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(15,23,42,.65)";
      ctx.font = "900 11px system-ui";
      ctx.fillText(city, x+8, y+4);
    });

    // legend
    ctx.fillStyle = "rgba(15,23,42,.75)";
    ctx.font = "900 12px system-ui";
    ctx.fillText("Legend:", 20, 26);
    ctx.strokeStyle = "rgba(37,99,235,.75)"; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(90, 22); ctx.lineTo(130, 22); ctx.stroke();
    ctx.fillText("On time", 140, 26);
    ctx.strokeStyle = "rgba(239,68,68,.75)"; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(230, 22); ctx.lineTo(270, 22); ctx.stroke();
    ctx.fillText("Incident/Delay", 280, 26);
  }

  function downloadCanvasPng(canvasId, filename){
    const c = $(canvasId);
    if (!c){ alert("Canvas not found."); return; }
    const a = document.createElement("a");
    a.href = c.toDataURL("image/png");
    a.download = filename;
    a.click();
  }

  function renderAll(){
    renderKPICardsAndDonuts();
    renderTable();
    renderCharts();
    drawRouteMap();
  }

  // Events
  $("gen").addEventListener("click", generate);
  $("dl").addEventListener("click", ()=>downloadCSV("lodisna_powerbi_shipments.csv", ROWS));
  $("onlyIncidents").addEventListener("click", ()=>{ incidentsOnly=true; renderTable(); drawRouteMap(); });
  $("showAll").addEventListener("click", ()=>{ incidentsOnly=false; renderTable(); drawRouteMap(); });
  $("search").addEventListener("input", ()=>{ renderTable(); drawRouteMap(); });

  ["gran","trendMetric","barMetric"].forEach(id => $(id).addEventListener("change", renderCharts));
  $("dlTrendPng").addEventListener("click", ()=>downloadChartPng(trendChart, "LODISNA_Trend.png"));
  $("dlBarPng").addEventListener("click", ()=>downloadChartPng(barChart, "LODISNA_ByTruck.png"));
  $("dlMapPng").addEventListener("click", ()=>downloadCanvasPng("routeMap", "LODISNA_RouteMap.png"));

  // Init
  generate();
</script>
</body>
</html>

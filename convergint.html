<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Convergint – Technical Operations Coordination Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Convergint-inspired technical operations coordination simulator with donut KPIs, search, exports for Power BI and SAP-style tables, and a downloadable PDF report." />

<style>
  :root{
    --bg1:#f6f8ff;
    --bg2:#ffffff;
    --card:#ffffff;
    --text:#0f172a;
    --muted:rgba(15,23,42,.68);
    --border:rgba(15,23,42,.12);
    --shadow:0 18px 40px rgba(15,23,42,.10);
    --blue:#2563eb;
    --red:#ef4444;
    --radius:18px;
    --max:1140px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1000px 650px at 10% 10%, rgba(37,99,235,.15), transparent 60%),
      radial-gradient(900px 650px at 90% 10%, rgba(239,68,68,.14), transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    line-height:1.5;
  }
  a{color:inherit;text-decoration:none}
  a:hover{text-decoration:underline}
  .container{max-width:var(--max);margin:0 auto;padding:22px}

  .top{
    position:sticky;top:0;z-index:50;
    background:rgba(255,255,255,.88);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--border);
  }
  .top-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:-.3px}
  .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--blue),var(--red));box-shadow:0 0 0 5px rgba(37,99,235,.12)}
  .sub{color:var(--muted);font-weight:800;font-size:.95rem;margin-top:2px}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{padding:9px 12px;border-radius:12px;border:1px solid transparent;font-weight:950;color:rgba(15,23,42,.92)}
  .nav a:hover{border-color:var(--border);background:rgba(15,23,42,.03);text-decoration:none}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  .section{padding:18px 0}
  h1{margin:0 0 10px;font-size:clamp(1.9rem,3vw,2.6rem);letter-spacing:-.9px;line-height:1.1}
  h2{margin:0 0 10px;letter-spacing:-.4px}
  h3{margin:0 0 8px;letter-spacing:-.3px}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1.12fr .88fr;gap:16px}
  @media(max-width:980px){.grid2{grid-template-columns:1fr}}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media(max-width:980px){.grid3{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.grid3{grid-template-columns:1fr}}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media(max-width:980px){.grid4{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.grid4{grid-template-columns:1fr}}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;border:1px solid var(--border);
    background:rgba(15,23,42,.02);font-weight:950;font-size:.9rem;color:rgba(15,23,42,.9);
  }
  .pill .pDot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 0 5px rgba(37,99,235,.12)}
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.02);font-weight:950;font-size:.88rem;color:rgba(15,23,42,.9);
  }
  .chip.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
  .chip.red{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:12px 14px;border-radius:14px;border:1px solid var(--border);
    background:rgba(255,255,255,.85);
    font-weight:950;cursor:pointer;
    box-shadow:0 12px 26px rgba(15,23,42,.10);
    user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .btn:hover{background:rgba(15,23,42,.02);border-color:rgba(15,23,42,.18);text-decoration:none}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,rgba(37,99,235,1),rgba(37,99,235,.82));border-color:rgba(37,99,235,.35);color:#fff}
  .btn.danger{background:linear-gradient(135deg,rgba(239,68,68,1),rgba(239,68,68,.82));border-color:rgba(239,68,68,.35);color:#fff}
  .btn.ghost{background:transparent;box-shadow:none}
  .btn.small{padding:9px 12px;border-radius:12px;font-size:.95rem}

  .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
  @media(max-width:980px){.controls{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.controls{grid-template-columns:1fr}}
  .field label{display:block;margin-bottom:6px;font-weight:950;font-size:.9rem;color:rgba(15,23,42,.85)}
  .field input,.field select{
    width:100%;padding:11px 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.16);
    background:#fff;color:var(--text);outline:none;
  }

  /* KPI cards */
  .kpi{
    border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.02);
    border-radius:14px;
    padding:12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .kpi .k{color:rgba(15,23,42,.72);font-weight:950;font-size:.9rem}
  .kpi .v{font-weight:950;font-size:1.15rem}

  /* DONUTS - FIXED (no overlap) */
  .donutWrap{
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:12px;
    margin-top:12px;
    align-items:stretch;
  }
  @media(max-width:980px){ .donutWrap{grid-template-columns:1fr} }
  .donutCard{
    border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.02);
    border-radius:14px;
    padding:12px;
    display:grid;
    grid-template-columns:140px 1fr;
    gap:12px;
    align-items:center;
  }
  .donutCanvas{
    width:120px;
    height:120px;
    display:block;
    margin:0 auto;
  }
  .donutText strong{font-weight:950}
  .donutText .muted{font-weight:800}

  /* Icons */
  .iconCard{
    border:1px solid rgba(15,23,42,.12);
    background:#fff;
    border-radius:14px;
    padding:12px;
    display:flex;gap:10px;align-items:center;
  }
  .icon{
    width:40px;height:40px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:linear-gradient(180deg, rgba(37,99,235,.10), rgba(239,68,68,.06));
    display:flex;align-items:center;justify-content:center;
    flex:0 0 auto;
  }
  .icon svg{width:22px;height:22px}
  .iconText strong{font-weight:950}
  .iconText span{color:var(--muted);font-weight:800;font-size:.9rem}

  /* Table */
  .tableWrap{
    margin-top:12px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.12);
    overflow:auto;
    background:#fff;
  }
  table{width:100%;border-collapse:collapse;min-width:1100px}
  th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:.92rem;white-space:nowrap;text-align:left}
  th{position:sticky;top:0;background:#fff;color:rgba(15,23,42,.75);font-weight:950;z-index:2}

  /* Search */
  .searchRow{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px
  }
  .searchRow input{
    flex:1 1 320px;
    padding:11px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.16);
    background:#fff;outline:none;font-weight:800
  }

  /* PDF report area */
  .reportArea{
    display:none;background:#fff;color:#0f172a;
    border-radius:16px;padding:16px;border:1px solid #e5e7eb;
  }
  .reportMeta{display:flex;gap:10px;flex-wrap:wrap;color:#334155;font-weight:900;margin-bottom:10px}
  .tag{
    display:inline-flex;padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(15,23,42,.03);
    font-weight:950;
  }
  .tag.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
  .tag.red{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}
</style>
</head>

<body>
<header class="top">
  <div class="container top-inner">
    <div>
      <div class="brand"><span class="dot"></span> Convergint – Technical Operations (Example)</div>
      <div class="sub">Work orders · Security systems · SLA compliance · Exports · PDF report</div>
    </div>
    <nav class="nav" aria-label="Page">
      <a href="#overview">Overview</a>
      <a href="#generator">Generator</a>
      <a href="#kpis">KPIs</a>
      <a href="#exports">Exports</a>
      <a class="btn small" href="index.html">← Back</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- OVERVIEW -->
  <section id="overview" class="section">
    <div class="grid2">
      <div class="card">
        <div class="row">
          <h1>Technical Operations Coordination</h1>
          <span class="pill"><span class="pDot"></span> structured + realistic</span>
        </div>
        <p class="muted" style="margin:8px 0 0">
          Professional example of a coordinator workflow: generating work orders, assigning a small team (max 5 technicians),
          tracking SLA compliance, and exporting clean tables for reporting.
        </p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn primary" href="#generator">Generate data</a>
          <a class="btn" href="#exports">Download exports</a>
          <button class="btn danger" id="btnPdf">Download PDF report</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <span class="chip blue">Power BI-ready</span>
          <span class="chip">SAP-style tables</span>
          <span class="chip red">Incidents + SLA</span>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Systems included</h2>
          <span class="chip blue">Essential only</span>
        </div>
        <div class="grid3" style="margin-top:12px">
          <div class="iconCard">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9h10l3 3H6L3 9z"></path>
                <path d="M14 9l2-2 5 5-2 2"></path>
                <path d="M6 12v5a2 2 0 0 0 2 2h4"></path>
              </svg>
            </div>
            <div class="iconText">
              <strong>Video Surveillance</strong>
              <span>Cameras · VMS · NVR</span>
            </div>
          </div>

          <div class="iconCard">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="7" y="10" width="10" height="10" rx="2"></rect>
                <path d="M9 10V7a3 3 0 0 1 6 0v3"></path>
              </svg>
            </div>
            <div class="iconText">
              <strong>Access Control</strong>
              <span>Doors · Readers · Badges</span>
            </div>
          </div>

          <div class="iconCard">
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2s4 4 4 8a4 4 0 0 1-8 0c0-4 4-8 4-8z"></path>
                <path d="M6 22h12"></path>
              </svg>
            </div>
            <div class="iconText">
              <strong>Fire & Life Safety</strong>
              <span>Panels · Devices · Testing</span>
            </div>
          </div>
        </div>

        <p class="muted" style="margin:12px 0 0">
          This simulator keeps only the fields that make sense for reporting: status, priority, SLA hours, incident type,
          technician assignment, and client/site context.
        </p>
      </div>
    </div>
  </section>

  <!-- GENERATOR -->
  <section id="generator" class="section">
    <div class="card">
      <div class="row">
        <h2>Data generator</h2>
        <span class="pill"><span class="pDot"></span> max 5 technicians</span>
      </div>

      <div class="controls">
        <div class="field">
          <label>Seed</label>
          <input id="seed" type="number" value="77" />
        </div>
        <div class="field">
          <label>Work orders</label>
          <input id="nOrders" type="number" min="30" max="600" value="140" />
        </div>
        <div class="field">
          <label>Days horizon</label>
          <input id="horizon" type="number" min="30" max="365" value="140" />
        </div>
        <div class="field">
          <label>Target SLA compliance %</label>
          <input id="slaTarget" type="number" min="70" max="99" value="92" />
        </div>
      </div>

      <div class="searchRow">
        <input id="search" type="text" placeholder="Search technician, client, site, incident, WO, system..." />
        <button class="btn primary" id="btnGenerate" type="button">Generate</button>
        <button class="btn" id="btnOverdue" type="button">Overdue only</button>
        <button class="btn ghost" id="btnAll" type="button">Show all</button>
      </div>

      <p class="muted" style="margin:10px 0 0">
        Search is applied to the table live (WO, technician, client, site, system, incident). This is what recruiters usually try first.
      </p>
    </div>
  </section>

  <!-- KPIs -->
  <section id="kpis" class="section">
    <div class="grid2">
      <div class="card">
        <div class="row">
          <h2 style="margin:0">Operational KPIs</h2>
          <span class="chip blue">Coordinator view</span>
        </div>

        <div class="grid4" style="margin-top:12px" id="kpiGrid"></div>
        <div class="donutWrap" id="donutWrap"></div>

        <p class="muted" style="margin:10px 0 0">
          Donut charts are intentionally simple: SLA compliance, overdue rate, and completion rate.
        </p>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Work orders</h2>
          <span class="chip">searchable</span>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>WO</th>
                <th>Date</th>
                <th>Client</th>
                <th>Site</th>
                <th>System</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Incident</th>
                <th>SLA (hrs)</th>
                <th>Tech</th>
                <th>Within SLA</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <p class="muted" style="margin:10px 0 0">
          Export the dataset and build a dashboard: SLA trend, overdue by system, workload by technician, incident mix.
        </p>
      </div>
    </div>
  </section>

  <!-- EXPORTS -->
  <section id="exports" class="section">
    <div class="card">
      <div class="row">
        <h2>Exports</h2>
        <span class="pill"><span class="pDot"></span> Power BI + SAP-style</span>
      </div>

      <div class="grid3" style="margin-top:12px">
        <div class="card" style="box-shadow:none">
          <h3>Power BI exports (CSV)</h3>
          <p class="muted" style="margin:6px 0 12px">
            Clean tables: work_orders, technicians, clients, assets.
          </p>
          <button class="btn primary" id="dlPB" type="button">Download Power BI CSV pack</button>
        </div>

        <div class="card" style="box-shadow:none">
          <h3>SAP-style exports (CSV)</h3>
          <p class="muted" style="margin:6px 0 12px">
            Notifications, service orders, confirmations.
          </p>
          <button class="btn" id="dlSAP" type="button">Download SAP CSV pack</button>
        </div>

        <div class="card" style="box-shadow:none">
          <h3>PDF reporting</h3>
          <p class="muted" style="margin:6px 0 12px">
            PDF snapshot with KPIs + charts (built from current data).
          </p>
          <button class="btn danger" id="dlPDF2" type="button">Download PDF report</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Hidden PDF report area -->
  <div class="container">
    <div class="reportArea" id="reportArea">
      <h2 style="margin:0">Convergint – Technical Operations Coordination (Example)</h2>
      <div class="reportMeta">
        <span class="tag blue">Security systems</span>
        <span class="tag">Work orders</span>
        <span class="tag red">SLA</span>
        <span class="tag">Demo data</span>
      </div>
      <p style="margin:0 0 10px;color:#334155;font-weight:800">
        Snapshot report generated from the simulator.
      </p>

      <h3 style="margin:10px 0 8px">KPIs</h3>
      <div id="reportKpis" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px"></div>

      <h3 style="margin:12px 0 8px">Charts</h3>
      <div id="reportCharts" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px"></div>

      <h3 style="margin:12px 0 6px">Notes</h3>
      <ul style="margin:0;padding-left:18px;color:#0f172a">
        <li>Technician assignment is capped at 5.</li>
        <li>Statuses and incidents are generated coherently for reporting workflows.</li>
        <li>Exports include Power BI-friendly tables and SAP-style operational tables.</li>
      </ul>
    </div>
  </div>

</main>

<footer style="text-align:center;padding:22px 0;color:rgba(15,23,42,.65);border-top:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.65);margin-top:18px">
  <div class="container">© Example simulator – Andrei Adam</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const $ = (id) => document.getElementById(id);

  // Seeded RNG
  function mulberry32(seed){
    let a = seed >>> 0;
    return function(){
      a += 0x6D2B79F5;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  const pad = (n, w=4) => String(n).padStart(w,"0");
  const iso = (d) => d.toISOString().slice(0,10);
  const addDays = (isoDate, n) => { const d=new Date(isoDate); d.setDate(d.getDate()+n); return iso(d); };

  // Max 5 technicians
  const TECHS = [
    {tech_id:"TECH-01", name:"Amina El-Sayed", phone:"+971 50 712 4431", region:"UAE"},
    {tech_id:"TECH-02", name:"Daniel Cho",     phone:"+1 415 555 0188",  region:"USA"},
    {tech_id:"TECH-03", name:"Sofia Petrov",   phone:"+359 88 773 2199", region:"BG"},
    {tech_id:"TECH-04", name:"Liam O'Connor",  phone:"+353 86 234 7781", region:"IE"},
    {tech_id:"TECH-05", name:"Mateo Alvarez",  phone:"+34 612 998 441",  region:"ES"}
  ];

  const SYSTEMS = [
    {key:"Video Surveillance", short:"CCTV/VMS", baseSla:12},
    {key:"Access Control", short:"ACS", baseSla:10},
    {key:"Fire & Life Safety", short:"FLS", baseSla:8}
  ];
  const PRIORITIES = [
    {p:"P1", label:"Critical", slaMul:0.65},
    {p:"P2", label:"High",     slaMul:0.85},
    {p:"P3", label:"Normal",   slaMul:1.00},
    {p:"P4", label:"Low",      slaMul:1.35}
  ];
  const CLIENTS = [
    {client_id:"CL-001", name:"Skyline Data Center Group", industry:"Data Centers"},
    {client_id:"CL-002", name:"MetroCare Hospital Network", industry:"Healthcare"},
    {client_id:"CL-003", name:"NorthGate Logistics Campus", industry:"Logistics"},
    {client_id:"CL-004", name:"AeroHub Regional Airport", industry:"Aviation"},
    {client_id:"CL-005", name:"Civic Services Complex", industry:"Public Sector"}
  ];
  const SITES = [
    "HQ – Building A","Warehouse – Gate 3","Terminal – Concourse 2","Clinic – West Wing","DC – Pod 7","Campus – Garage Level 1"
  ];
  const FAILURE_MODES = [
    "Camera offline","Reader not responding","Panel trouble","Network port down","Power supply fault","False alarm investigation"
  ];

  let DATA = { work_orders: [], assets: [], notifications: [], service_orders: [], confirmations: [] };
  let showOverdueOnly = false;

  function downloadCSV(filename, rows){
    if(!rows || !rows.length){
      alert("Please generate data first.");
      return;
    }
    const headers = Object.keys(rows[0]);
    const lines = [headers.join(",")];
    for(const r of rows){
      const line = headers.map(h=>{
        const s = String(r[h] ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
        return s;
      }).join(",");
      lines.push(line);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function drawDonut(canvas, value01, label, strokeStyle){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)/2 - 10;

    ctx.clearRect(0,0,w,h);

    ctx.lineWidth = 12;
    ctx.lineCap = "round";

    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.stroke();

    const start = -Math.PI/2;
    const end = start + Math.PI*2*Math.max(0, Math.min(1, value01));
    ctx.strokeStyle = strokeStyle;
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end);
    ctx.stroke();

    ctx.fillStyle = "rgba(15,23,42,.92)";
    ctx.font = "900 16px system-ui";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(Math.round(value01*100) + "%", cx, cy-2);

    ctx.fillStyle = "rgba(15,23,42,.65)";
    ctx.font = "800 11px system-ui";
    ctx.fillText(label, cx, cy+16);
  }

  function donutCard(title, value01, label, color){
    const card = document.createElement("div");
    card.className = "donutCard";
    card.innerHTML = `
      <div>
        <canvas class="donutCanvas" width="120" height="120" aria-label="${title} chart"></canvas>
      </div>
      <div class="donutText">
        <strong>${title}</strong>
        <div class="muted">${Math.round(value01*100)}% · ${label}</div>
        <div style="margin-top:10px">
          <span class="chip">${label}</span>
        </div>
      </div>
    `;
    const c = card.querySelector("canvas");
    drawDonut(c, value01, label, color);
    return card;
  }

  function generate(){
    const seed = +$("seed").value || 77;
    const n = +$("nOrders").value || 140;
    const horizon = +$("horizon").value || 140;
    const slaTarget = Math.max(0.70, Math.min(0.99, (+$("slaTarget").value || 92)/100));
    const rnd = mulberry32(seed);

    DATA = { work_orders: [], assets: [], notifications: [], service_orders: [], confirmations: [] };

    const start = (()=>{ const d=new Date(); d.setDate(d.getDate()-horizon); return iso(d); })();
    const pick = (arr) => arr[Math.floor(rnd()*arr.length)];

    // Assets (small, coherent)
    let assetCounter = 1;
    for(const c of CLIENTS){
      for(const s of SYSTEMS){
        const count = 3 + Math.floor(rnd()*5);
        for(let i=0;i<count;i++){
          const asset_id = "AS-" + pad(assetCounter++, 4);
          DATA.assets.push({
            asset_id,
            client_id: c.client_id,
            system: s.key,
            model: (s.key==="Video Surveillance") ? ["IP Camera","NVR","VMS Server"][Math.floor(rnd()*3)]
                 : (s.key==="Access Control") ? ["Door Controller","Card Reader","Power Supply"][Math.floor(rnd()*3)]
                 : ["Fire Panel","Smoke Detector","Horn/Strobe"][Math.floor(rnd()*3)],
            location: SITES[Math.floor(rnd()*SITES.length)]
          });
        }
      }
    }

    for(let i=1;i<=n;i++){
      const wo_id = "WO-" + pad(i, 5);
      const client = pick(CLIENTS);
      const sys = pick(SYSTEMS);
      const pr = pick(PRIORITIES);
      const tech = pick(TECHS);
      const date = addDays(start, Math.floor(rnd()*horizon));
      const asset = pick(DATA.assets.filter(a => a.client_id === client.client_id && a.system === sys.key));

      const sla_hours = Math.max(4, Math.round(sys.baseSla * pr.slaMul * (0.9 + rnd()*0.3)));

      const severityPenalty = (pr.p==="P1") ? 0.04 : (pr.p==="P2") ? 0.02 : 0;
      const systemPenalty = (sys.key==="Video Surveillance") ? 0.01 : 0;
      const withinProb = Math.max(0.65, Math.min(0.99, slaTarget - severityPenalty - systemPenalty));
      const within_sla = (rnd() < withinProb) ? "Yes" : "No";

      const incident_flag = (rnd() < 0.30) ? "Yes" : "No";
      const incident = (incident_flag==="Yes") ? pick(FAILURE_MODES) : "None";

      const status = (within_sla==="No" && rnd()<0.55) ? "Overdue"
                   : (rnd()<0.62) ? "Completed"
                   : (rnd()<0.88) ? "In Progress"
                   : "Scheduled";

      DATA.work_orders.push({
        wo_id,
        date,
        client_id: client.client_id,
        client_name: client.name,
        industry: client.industry,
        site: asset ? asset.location : pick(SITES),
        system: sys.key,
        priority: pr.p,
        status,
        incident,
        sla_hours,
        within_sla,
        assigned_tech: tech.name,
        tech_id: tech.tech_id,
        asset_id: asset ? asset.asset_id : ""
      });

      // SAP-style minimal chain
      const notif = "N-" + pad(i, 6);
      const so = "SO-" + pad(i, 6);
      const conf = "C-" + pad(i, 6);

      DATA.notifications.push({
        notif_id: notif,
        created_on: date,
        client_id: client.client_id,
        system: sys.key,
        priority: pr.p,
        asset_id: asset ? asset.asset_id : "",
        short_text: (incident!=="None") ? incident : (sys.short + " service request")
      });

      DATA.service_orders.push({
        service_order_id: so,
        notif_id: notif,
        start_date: date,
        planned_finish: addDays(date, Math.max(0, Math.floor(rnd()*3))),
        sla_hours,
        tech_id: tech.tech_id,
        status: (status==="Completed") ? "TECO" : "REL"
      });

      const labor_h = Math.max(1, Math.round(1 + rnd()*4 + (pr.p==="P1"?2:0)));
      DATA.confirmations.push({
        confirmation_id: conf,
        service_order_id: so,
        tech_id: tech.tech_id,
        confirmed_on: (status==="Completed") ? addDays(date, Math.max(0, Math.floor(rnd()*3))) : "",
        labor_hours: labor_h,
        final_status: (status==="Completed") ? "Completed" : "Open"
      });
    }

    renderAll();
  }

  function computeKPIs(){
    const wo = DATA.work_orders;
    const total = wo.length || 1;
    const completed = wo.filter(x => x.status === "Completed").length;
    const within = wo.filter(x => x.within_sla === "Yes").length;
    const overdue = wo.filter(x => x.status === "Overdue" || x.within_sla === "No").length;

    const avgSla = wo.length ? (wo.reduce((a,x)=>a + (+x.sla_hours||0), 0) / wo.length) : 0;

    return {
      total,
      completed,
      withinPct: within/total,
      overduePct: overdue/total,
      completionPct: completed/total,
      avgSla
    };
  }

  function renderKPIs(){
    const k = computeKPIs();
    $("kpiGrid").innerHTML = `
      <div class="kpi"><div><div class="k">Work orders</div><div class="v">${k.total}</div></div><span class="chip">Total</span></div>
      <div class="kpi"><div><div class="k">Completed</div><div class="v">${k.completed}</div></div><span class="chip blue">Done</span></div>
      <div class="kpi"><div><div class="k">Avg SLA (hrs)</div><div class="v">${k.avgSla.toFixed(1)}</div></div><span class="chip">Hours</span></div>
      <div class="kpi"><div><div class="k">Overdue / breached</div><div class="v">${Math.round(k.overduePct*100)}%</div></div><span class="chip red">Risk</span></div>
    `;

    $("donutWrap").innerHTML = "";
    $("donutWrap").appendChild(donutCard("SLA Compliance", k.withinPct, "Within SLA", "rgba(37,99,235,1)"));
    $("donutWrap").appendChild(donutCard("Overdue Rate", k.overduePct, "Overdue", "rgba(239,68,68,1)"));
    $("donutWrap").appendChild(donutCard("Completion Rate", k.completionPct, "Completed", "rgba(15,23,42,.86)"));
  }

  function applySearchFilter(rows){
    const q = ($("search").value || "").trim().toLowerCase();
    if(!q) return rows;

    return rows.filter(r => {
      const hay = [
        r.wo_id, r.date, r.client_name, r.site, r.system, r.priority,
        r.status, r.incident, r.assigned_tech, r.tech_id, r.within_sla
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function renderTable(){
    let rows = DATA.work_orders.slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
    if (showOverdueOnly) rows = rows.filter(x => x.within_sla === "No" || x.status === "Overdue");
    rows = applySearchFilter(rows);

    const body = $("tbody");
    body.innerHTML = "";
    rows.slice(0, 200).forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.wo_id}</td>
        <td>${x.date}</td>
        <td>${x.client_name}</td>
        <td>${x.site}</td>
        <td>${x.system}</td>
        <td>${x.priority}</td>
        <td>${x.status}</td>
        <td>${x.incident}</td>
        <td>${x.sla_hours}</td>
        <td>${x.assigned_tech}</td>
        <td>${x.within_sla}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderAll(){
    renderKPIs();
    renderTable();
  }

  function downloadPowerBIPack(){
    const technicians = TECHS.map(t => ({
      tech_id: t.tech_id,
      technician: t.name,
      region: t.region,
      phone: t.phone
    }));
    const clients = CLIENTS.map(c => ({
      client_id: c.client_id,
      client_name: c.name,
      industry: c.industry
    }));

    downloadCSV("powerbi_work_orders.csv", DATA.work_orders);
    downloadCSV("powerbi_assets.csv", DATA.assets);
    downloadCSV("powerbi_technicians.csv", technicians);
    downloadCSV("powerbi_clients.csv", clients);
  }

  function downloadSAPPack(){
    downloadCSV("sap_notifications.csv", DATA.notifications);
    downloadCSV("sap_service_orders.csv", DATA.service_orders);
    downloadCSV("sap_confirmations.csv", DATA.confirmations);
  }

  async function downloadPDFReport(){
    const k = computeKPIs();

    $("reportKpis").innerHTML = `
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Work orders</div>
        <div style="font-weight:950;font-size:18px">${k.total}</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Completed</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.completionPct*100)}%</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">SLA compliance</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.withinPct*100)}%</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Overdue rate</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.overduePct*100)}%</div>
      </div>
    `;

    $("reportCharts").innerHTML = "";
    const mk = (title, value, color) => {
      const div = document.createElement("div");
      div.style.border="1px solid #e5e7eb";
      div.style.borderRadius="12px";
      div.style.padding="10px";
      div.innerHTML = `<div style="font-weight:950;margin-bottom:6px;color:#0f172a">${title}</div>`;
      const c = document.createElement("canvas");
      c.width=240; c.height=160;
      div.appendChild(c);
      // simple donut
      const ctx = c.getContext("2d");
      const cx=80, cy=80, r=52;
      ctx.lineWidth=12; ctx.lineCap="round";
      ctx.strokeStyle="rgba(15,23,42,.12)";
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
      const start=-Math.PI/2;
      ctx.strokeStyle=color;
      ctx.beginPath(); ctx.arc(cx,cy,r,start,start+Math.PI*2*Math.max(0,Math.min(1,value))); ctx.stroke();
      ctx.fillStyle="rgba(15,23,42,.92)";
      ctx.font="900 16px system-ui";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(Math.round(value*100)+"%", cx, cy);
      ctx.fillStyle="rgba(15,23,42,.75)";
      ctx.font="900 12px system-ui";
      ctx.textAlign="left"; ctx.textBaseline="alphabetic";
      ctx.fillText("KPI snapshot", 150, 86);
      $("reportCharts").appendChild(div);
    };

    mk("SLA compliance", k.withinPct, "rgba(37,99,235,1)");
    mk("Overdue rate", k.overduePct, "rgba(239,68,68,1)");
    mk("Completion rate", k.completionPct, "rgba(15,23,42,.86)");

    const area = $("reportArea");
    area.style.display="block";
    await new Promise(r=>setTimeout(r, 60));

    const canvas = await html2canvas(area, {scale:2, useCORS:true});
    const img = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const imgW = pageW - 48;
    const imgH = canvas.height * (imgW / canvas.width);

    if (imgH <= pageH - 48){
      pdf.addImage(img, "PNG", 24, 24, imgW, imgH);
    } else {
      let remaining = imgH;
      let srcY = 0;
      const sliceH = canvas.width * ((pageH - 48) / imgW);

      while (remaining > 0){
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = canvas.width;
        pageCanvas.height = Math.min(sliceH, canvas.height - srcY);
        const ctx = pageCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, srcY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);

        const pageImg = pageCanvas.toDataURL("image/png");
        const pageImgH = pageCanvas.height * (imgW / pageCanvas.width);

        pdf.addImage(pageImg, "PNG", 24, 24, imgW, pageImgH);
        remaining -= (pageH - 48);
        srcY += pageCanvas.height;
        if (remaining > 0) pdf.addPage();
      }
    }

    pdf.save("Convergint_Technical_Ops_Report.pdf");
    area.style.display="none";
  }

  // Events
  $("btnGenerate").addEventListener("click", () => { showOverdueOnly=false; generate(); });
  $("btnOverdue").addEventListener("click", () => { showOverdueOnly=true; renderTable(); });
  $("btnAll").addEventListener("click", () => { showOverdueOnly=false; renderTable(); });
  $("search").addEventListener("input", renderTable);

  $("dlPB").addEventListener("click", downloadPowerBIPack);
  $("dlSAP").addEventListener("click", downloadSAPPack);
  $("btnPdf").addEventListener("click", downloadPDFReport);
  $("dlPDF2").addEventListener("click", downloadPDFReport);

  // Init
  generate();
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Convergint – Technical Operations Coordination Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Convergint-inspired technical operations simulator: max 5 technicians, work orders, SLA, incidents, exports, PDF report, interactive charts + SLA heatmap." />

<style>
  :root{
    --bg1:#f6f8ff; --bg2:#ffffff; --card:#ffffff;
    --text:#0f172a; --muted:rgba(15,23,42,.68);
    --border:rgba(15,23,42,.12); --shadow:0 18px 40px rgba(15,23,42,.10);
    --blue:#2563eb; --red:#ef4444; --radius:18px; --max:1140px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1000px 650px at 10% 10%, rgba(37,99,235,.15), transparent 60%),
      radial-gradient(900px 650px at 90% 10%, rgba(239,68,68,.14), transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    line-height:1.55;
  }
  a{color:inherit;text-decoration:none}
  a:hover{text-decoration:underline}
  .container{max-width:var(--max);margin:0 auto;padding:22px}

  .top{
    position:sticky;top:0;z-index:50;
    background:rgba(255,255,255,.88);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--border);
  }
  .top-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:-.3px}
  .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--blue),var(--red));box-shadow:0 0 0 5px rgba(37,99,235,.12)}
  .sub{color:var(--muted);font-weight:800;font-size:.95rem;margin-top:2px}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{padding:9px 12px;border-radius:12px;border:1px solid transparent;font-weight:950;color:rgba(15,23,42,.92)}
  .nav a:hover{border-color:var(--border);background:rgba(15,23,42,.03);text-decoration:none}

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .section{padding:18px 0}
  h1{margin:0 0 10px;font-size:clamp(1.9rem,3vw,2.6rem);letter-spacing:-.9px;line-height:1.1}
  h2{margin:0 0 10px;letter-spacing:-.4px}
  h3{margin:0 0 8px;letter-spacing:-.3px}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media(max-width:980px){.grid2{grid-template-columns:1fr}}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media(max-width:980px){.grid3{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.grid3{grid-template-columns:1fr}}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media(max-width:980px){.grid4{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.grid4{grid-template-columns:1fr}}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(15,23,42,.02);font-weight:950;font-size:.9rem;color:rgba(15,23,42,.9)}
  .pill .pDot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 0 5px rgba(37,99,235,.12)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.02);font-weight:950;font-size:.88rem;color:rgba(15,23,42,.9)}
  .chip.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
  .chip.red{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:12px 14px;border-radius:14px;border:1px solid var(--border);
    background:rgba(255,255,255,.85);font-weight:950;cursor:pointer;
    box-shadow:0 12px 26px rgba(15,23,42,.10);user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .btn:hover{background:rgba(15,23,42,.02);border-color:rgba(15,23,42,.18);text-decoration:none}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,rgba(37,99,235,1),rgba(37,99,235,.82));border-color:rgba(37,99,235,.35);color:#fff}
  .btn.danger{background:linear-gradient(135deg,rgba(239,68,68,1),rgba(239,68,68,.82));border-color:rgba(239,68,68,.35);color:#fff}
  .btn.ghost{background:transparent;box-shadow:none}
  .btn.small{padding:9px 12px;border-radius:12px;font-size:.95rem}

  .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
  @media(max-width:980px){.controls{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.controls{grid-template-columns:1fr}}
  .field label{display:block;margin-bottom:6px;font-weight:950;font-size:.9rem;color:rgba(15,23,42,.85)}
  .field input,.field select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.16);background:#fff;color:var(--text);outline:none;font-weight:800}

  .kpi{border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.02);border-radius:14px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .kpi .k{color:rgba(15,23,42,.72);font-weight:950;font-size:.9rem}
  .kpi .v{font-weight:950;font-size:1.15rem}

  .searchRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .searchRow input{flex:1 1 320px;padding:11px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.16);background:#fff;outline:none;font-weight:800}

  .tableWrap{margin-top:12px;border-radius:14px;border:1px solid rgba(15,23,42,.12);overflow:auto;background:#fff}
  table{width:100%;border-collapse:collapse;min-width:1200px}
  th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:.92rem;white-space:nowrap;text-align:left}
  th{position:sticky;top:0;background:#fff;color:rgba(15,23,42,.75);font-weight:950;z-index:2}

  /* Charts */
  .chartsGrid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px;margin-top:12px}
  @media(max-width:980px){.chartsGrid{grid-template-columns:1fr}}
  .chartCard{border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:14px;padding:12px}
  .chartCanvasWrap{position:relative;height:320px}
  @media(max-width:980px){.chartCanvasWrap{height:300px}}

  /* Donuts bottom */
  .donutGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;align-items:stretch;margin-top:12px}
  @media(max-width:980px){.donutGrid{grid-template-columns:1fr}}
  .donutCard{border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.02);border-radius:14px;padding:12px;display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center}
  .donutCanvas{width:120px;height:120px;display:block;margin:0 auto}
  .donutText strong{font-weight:950}
  .donutText .muted{font-weight:800}

  /* Heatmap block */
  .heatWrap{margin-top:12px;border:1px solid rgba(15,23,42,.12);border-radius:14px;overflow:hidden;background:#fff}
  .heatHead{padding:12px;border-bottom:1px solid rgba(15,23,42,.10);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:baseline}
  .heatCanvas{width:100%;display:block}

  /* PDF report area */
  .reportArea{display:none;background:#fff;color:#0f172a;border-radius:16px;padding:16px;border:1px solid #e5e7eb}
  .reportMeta{display:flex;gap:10px;flex-wrap:wrap;color:#334155;font-weight:900;margin-bottom:10px}
  .tag{display:inline-flex;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.03);font-weight:950}
  .tag.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
  .tag.red{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08)}
</style>
</head>

<body>
<header class="top">
  <div class="container top-inner">
    <div>
      <div class="brand"><span class="dot"></span> Convergint – Technical Operations (Example)</div>
      <div class="sub">Work orders · Security systems · SLA · Exports · PDF · Charts + Heatmap</div>
    </div>
    <nav class="nav" aria-label="Page">
      <a href="#overview">Overview</a>
      <a href="#generator">Generator</a>
      <a href="#table">Table</a>
      <a href="#charts">Charts</a>
      <a href="#analytics">Analytics</a>
      <a href="#exports">Exports</a>
      <a class="btn small" href="index.html">← Back</a>
    </nav>
  </div>
</header>

<main class="container">

  <section id="overview" class="section">
    <div class="grid2">
      <div class="card">
        <div class="row">
          <h1>Technical Operations Coordination</h1>
          <span class="pill"><span class="pDot"></span> realistic reporting</span>
        </div>
        <p class="muted" style="margin:8px 0 0">
          Example coordinator workflow: generate work orders, assign max 5 technicians, measure SLA performance, and export structured data.
        </p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn primary" href="#generator">Generate data</a>
          <a class="btn" href="#analytics">Open analytics</a>
          <button class="btn danger" id="btnPdf" type="button">Download PDF report</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <span class="chip blue">Power BI-ready</span>
          <span class="chip">SAP-style tables</span>
          <span class="chip red">SLA + incidents</span>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Systems included</h2>
          <span class="chip blue">coherent</span>
        </div>

        <div class="grid3" style="margin-top:12px">
          <div class="card" style="box-shadow:none;border:1px solid rgba(15,23,42,.12);border-radius:14px">
            <h3 style="margin:0 0 6px">Video Surveillance</h3>
            <p class="muted" style="margin:0">Cameras · VMS · NVR</p>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(15,23,42,.12);border-radius:14px">
            <h3 style="margin:0 0 6px">Access Control</h3>
            <p class="muted" style="margin:0">Doors · Readers · Badges</p>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(15,23,42,.12);border-radius:14px">
            <h3 style="margin:0 0 6px">Fire & Life Safety</h3>
            <p class="muted" style="margin:0">Panels · Devices · Testing</p>
          </div>
        </div>

        <p class="muted" style="margin:12px 0 0">
          The analytics sections focus on practical stories: SLA trend, overdue spikes, incident mix, and workload distribution.
        </p>
      </div>
    </div>
  </section>

  <section id="generator" class="section">
    <div class="card">
      <div class="row">
        <h2>Data generator</h2>
        <span class="pill"><span class="pDot"></span> max 5 technicians</span>
      </div>

      <div class="controls">
        <div class="field">
          <label>Seed</label>
          <input id="seed" type="number" value="77" />
        </div>
        <div class="field">
          <label>Work orders</label>
          <input id="nOrders" type="number" min="30" max="800" value="220" />
        </div>
        <div class="field">
          <label>Days horizon</label>
          <input id="horizon" type="number" min="60" max="900" value="540" />
        </div>
        <div class="field">
          <label>Target SLA compliance %</label>
          <input id="slaTarget" type="number" min="70" max="99" value="92" />
        </div>
      </div>

      <div class="searchRow">
        <input id="search" type="text" placeholder="Search technician, client, site, incident, WO, system..." />
        <button class="btn primary" id="btnGenerate" type="button">Generate</button>
        <button class="btn" id="btnOverdue" type="button">Overdue only</button>
        <button class="btn ghost" id="btnAll" type="button">Show all</button>
      </div>

      <p class="muted" style="margin:10px 0 0">
        Search is applied to the table. Charts show operational patterns from the full dataset.
      </p>
    </div>
  </section>

  <section id="table" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Work orders table</h2>
        <span class="chip">searchable</span>
      </div>

      <div class="grid4" style="margin-top:12px" id="kpiGrid"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>WO</th>
              <th>Date</th>
              <th>Client</th>
              <th>Site</th>
              <th>System</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Incident</th>
              <th>SLA (hrs)</th>
              <th>Tech</th>
              <th>Within SLA</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="charts" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Interactive Operations Dashboard</h2>
        <span class="chip blue">line + bar</span>
      </div>

      <div class="controls" style="margin-top:12px">
        <div class="field">
          <label>Granularity</label>
          <select id="gran">
            <option value="month" selected>Month</option>
            <option value="day">Day</option>
            <option value="year">Year</option>
          </select>
        </div>
        <div class="field">
          <label>Trend metric</label>
          <select id="trendMetric">
            <option value="slaCompliance" selected>SLA compliance (%)</option>
            <option value="overdueRate">Overdue rate (%)</option>
            <option value="completionRate">Completion rate (%)</option>
            <option value="workOrders">Work orders count</option>
          </select>
        </div>
        <div class="field">
          <label>Bar metric</label>
          <select id="barMetric">
            <option value="incidentsBySystem" selected>Incidents by system</option>
            <option value="workloadByTech">Workload by technician</option>
            <option value="overdueBySystem">Overdue by system</option>
          </select>
        </div>
        <div class="field">
          <label>Downloads</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn small" id="dlTrendPng" type="button">Trend PNG</button>
            <button class="btn small" id="dlBarPng" type="button">Bar PNG</button>
          </div>
        </div>
      </div>

      <div class="chartsGrid">
        <div class="chartCard">
          <div class="row">
            <h3 style="margin:0">Trend chart</h3>
            <span class="chip">time series</span>
          </div>
          <div class="chartCanvasWrap"><canvas id="trendChart"></canvas></div>
          <p class="muted" style="margin:10px 0 0">Useful for: SLA drift, operational pressure spikes, performance improvements.</p>
        </div>

        <div class="chartCard">
          <div class="row">
            <h3 style="margin:0">Operational breakdown</h3>
            <span class="chip red">root cause</span>
          </div>
          <div class="chartCanvasWrap"><canvas id="barChart"></canvas></div>
          <p class="muted" style="margin:10px 0 0">Useful for: workload balance (tech) and incident concentration (system).</p>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <h2 style="margin:0">Operational KPIs (Donuts)</h2>
        <span class="chip blue">quick view</span>
      </div>
      <div class="donutGrid" id="donutGrid"></div>
    </div>
  </section>

  <!-- Advanced analytics: SLA trend + Heatmap -->
  <section id="analytics" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Advanced Analytics</h2>
        <span class="chip blue">trend + heatmap</span>
      </div>
      <p class="muted" style="margin:10px 0 0">
        A practical view for coordinators: SLA evolution and system-week performance patterns.
      </p>

      <div class="chartCard" style="margin-top:12px">
        <div class="row">
          <h3 style="margin:0">Weekly SLA compliance (extra trend)</h3>
          <span class="chip">weekly</span>
        </div>
        <div class="chartCanvasWrap"><canvas id="slaTrend"></canvas></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn small" id="dlSlaTrendPng" type="button">Weekly Trend PNG</button>
        </div>
      </div>

      <div class="heatWrap">
        <div class="heatHead">
          <div>
            <h3 style="margin:0">SLA Heatmap (System × Month)</h3>
            <p class="muted" style="margin:6px 0 0">Green = strong compliance, red = risk/pressure</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn small" id="dlHeatPng" type="button">Heatmap PNG</button>
          </div>
        </div>
        <canvas id="slaHeatmap" width="1100" height="340" class="heatCanvas"></canvas>
      </div>
    </div>
  </section>

  <section id="exports" class="section">
    <div class="card">
      <div class="row">
        <h2>Exports</h2>
        <span class="pill"><span class="pDot"></span> Power BI + SAP-style</span>
      </div>

      <div class="grid3" style="margin-top:12px">
        <div class="card" style="box-shadow:none">
          <h3>Power BI exports (CSV)</h3>
          <p class="muted" style="margin:6px 0 12px">work_orders, technicians, clients, assets.</p>
          <button class="btn primary" id="dlPB" type="button">Download Power BI CSV pack</button>
        </div>

        <div class="card" style="box-shadow:none">
          <h3>SAP-style exports (CSV)</h3>
          <p class="muted" style="margin:6px 0 12px">notifications, service_orders, confirmations.</p>
          <button class="btn" id="dlSAP" type="button">Download SAP CSV pack</button>
        </div>

        <div class="card" style="box-shadow:none">
          <h3>PDF reporting</h3>
          <p class="muted" style="margin:6px 0 12px">PDF snapshot with KPIs + charts.</p>
          <button class="btn danger" id="dlPDF2" type="button">Download PDF report</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Hidden PDF report area -->
  <div class="container">
    <div class="reportArea" id="reportArea">
      <h2 style="margin:0">Convergint – Technical Operations Coordination (Example)</h2>
      <div class="reportMeta">
        <span class="tag blue">Security systems</span>
        <span class="tag">Work orders</span>
        <span class="tag red">SLA</span>
        <span class="tag">Demo data</span>
      </div>
      <p style="margin:0 0 10px;color:#334155;font-weight:800">Snapshot report generated from the simulator.</p>

      <h3 style="margin:10px 0 8px">KPIs</h3>
      <div id="reportKpis" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px"></div>

      <h3 style="margin:12px 0 8px">Charts</h3>
      <div id="reportCharts" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px"></div>
    </div>
  </div>

</main>

<footer style="text-align:center;padding:22px 0;color:rgba(15,23,42,.65);border-top:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.65);margin-top:18px">
  <div class="container">© Example simulator – Andrei Adam</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const $ = (id) => document.getElementById(id);

  function mulberry32(seed){
    let a = seed >>> 0;
    return function(){
      a += 0x6D2B79F5;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  const pad = (n, w=4) => String(n).padStart(w,"0");
  const iso = (d) => d.toISOString().slice(0,10);
  const addDays = (isoDate, n) => { const d=new Date(isoDate); d.setDate(d.getDate()+n); return iso(d); };

  // Max 5 technicians
  const TECHS = [
    {tech_id:"TECH-01", name:"Amina El-Sayed", phone:"+971 50 712 4431", region:"UAE"},
    {tech_id:"TECH-02", name:"Daniel Cho",     phone:"+1 415 555 0188",  region:"USA"},
    {tech_id:"TECH-03", name:"Sofia Petrov",   phone:"+359 88 773 2199", region:"BG"},
    {tech_id:"TECH-04", name:"Liam O'Connor",  phone:"+353 86 234 7781", region:"IE"},
    {tech_id:"TECH-05", name:"Mateo Alvarez",  phone:"+34 612 998 441",  region:"ES"}
  ];

  const SYSTEMS = [
    {key:"Video Surveillance", short:"CCTV/VMS", baseSla:12},
    {key:"Access Control", short:"ACS", baseSla:10},
    {key:"Fire & Life Safety", short:"FLS", baseSla:8}
  ];
  const PRIORITIES = [
    {p:"P1", label:"Critical", slaMul:0.65},
    {p:"P2", label:"High",     slaMul:0.85},
    {p:"P3", label:"Normal",   slaMul:1.00},
    {p:"P4", label:"Low",      slaMul:1.35}
  ];
  const CLIENTS = [
    {client_id:"CL-001", name:"Skyline Data Center Group", industry:"Data Centers"},
    {client_id:"CL-002", name:"MetroCare Hospital Network", industry:"Healthcare"},
    {client_id:"CL-003", name:"NorthGate Logistics Campus", industry:"Logistics"},
    {client_id:"CL-004", name:"AeroHub Regional Airport", industry:"Aviation"},
    {client_id:"CL-005", name:"Civic Services Complex", industry:"Public Sector"}
  ];
  const SITES = ["HQ – Building A","Warehouse – Gate 3","Terminal – Concourse 2","Clinic – West Wing","DC – Pod 7","Campus – Garage Level 1"];
  const FAILURE_MODES = ["Camera offline","Reader not responding","Panel trouble","Network port down","Power supply fault","False alarm investigation"];

  let DATA = { work_orders: [], assets: [], notifications: [], service_orders: [], confirmations: [] };
  let showOverdueOnly = false;

  let trendChart = null;
  let barChart = null;
  let weeklyTrendChart = null;

  function downloadCSV(filename, rows){
    if(!rows || !rows.length){ alert("Please generate data first."); return; }
    const headers = Object.keys(rows[0]);
    const lines = [headers.join(",")];
    for(const r of rows){
      const line = headers.map(h=>{
        const s = String(r[h] ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
        return s;
      }).join(",");
      lines.push(line);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Donuts
  function drawDonut(canvas, value01, label, strokeStyle){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)/2 - 10;

    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = 12; ctx.lineCap = "round";

    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();

    const start = -Math.PI/2;
    const end = start + Math.PI*2*Math.max(0, Math.min(1, value01));
    ctx.strokeStyle = strokeStyle;
    ctx.beginPath(); ctx.arc(cx, cy, r, start, end); ctx.stroke();

    ctx.fillStyle = "rgba(15,23,42,.92)";
    ctx.font = "900 16px system-ui";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(Math.round(value01*100) + "%", cx, cy-2);

    ctx.fillStyle = "rgba(15,23,42,.65)";
    ctx.font = "800 11px system-ui";
    ctx.fillText(label, cx, cy+16);
  }

  function donutCard(title, value01, label, color, footerText){
    const card = document.createElement("div");
    card.className = "donutCard";
    card.innerHTML = `
      <div><canvas class="donutCanvas" width="120" height="120" aria-label="${title} chart"></canvas></div>
      <div class="donutText">
        <strong>${title}</strong>
        <div class="muted">${footerText}</div>
        <div style="margin-top:10px"><span class="chip">${label}</span></div>
      </div>
    `;
    drawDonut(card.querySelector("canvas"), value01, label, color);
    return card;
  }

  function groupKey(date, gran){
    if (gran === "day") return date;
    if (gran === "month") return date.slice(0,7);
    return date.slice(0,4);
  }

  function generate(){
    const seed = +$("seed").value || 77;
    const n = +$("nOrders").value || 220;
    const horizon = +$("horizon").value || 540;
    const slaTarget = Math.max(0.70, Math.min(0.99, (+$("slaTarget").value || 92)/100));
    const rnd = mulberry32(seed);

    DATA = { work_orders: [], assets: [], notifications: [], service_orders: [], confirmations: [] };
    const start = (()=>{ const d=new Date(); d.setDate(d.getDate()-horizon); return iso(d); })();
    const pick = (arr) => arr[Math.floor(rnd()*arr.length)];

    // assets
    let assetCounter = 1;
    for(const c of CLIENTS){
      for(const s of SYSTEMS){
        const count = 4 + Math.floor(rnd()*6);
        for(let i=0;i<count;i++){
          const asset_id = "AS-" + pad(assetCounter++, 4);
          DATA.assets.push({
            asset_id,
            client_id: c.client_id,
            system: s.key,
            model: (s.key==="Video Surveillance") ? ["IP Camera","NVR","VMS Server"][Math.floor(rnd()*3)]
                 : (s.key==="Access Control") ? ["Door Controller","Card Reader","Power Supply"][Math.floor(rnd()*3)]
                 : ["Fire Panel","Smoke Detector","Horn/Strobe"][Math.floor(rnd()*3)],
            location: SITES[Math.floor(rnd()*SITES.length)]
          });
        }
      }
    }

    for(let i=1;i<=n;i++){
      const wo_id = "WO-" + pad(i, 5);
      const client = pick(CLIENTS);
      const sys = pick(SYSTEMS);
      const pr = pick(PRIORITIES);
      const tech = pick(TECHS);
      const date = addDays(start, Math.floor(rnd()*horizon));
      const asset = pick(DATA.assets.filter(a => a.client_id === client.client_id && a.system === sys.key));

      const sla_hours = Math.max(4, Math.round(sys.baseSla * pr.slaMul * (0.9 + rnd()*0.3)));

      const severityPenalty = (pr.p==="P1") ? 0.05 : (pr.p==="P2") ? 0.03 : 0;
      const systemPenalty = (sys.key==="Video Surveillance") ? 0.015 : 0;
      const month = Number(date.slice(5,7));
      const seasonPenalty = (month>=11 || month<=2) ? 0.01 : 0;

      const withinProb = Math.max(0.60, Math.min(0.99, slaTarget - severityPenalty - systemPenalty - seasonPenalty));
      const within_sla = (rnd() < withinProb) ? "Yes" : "No";

      const incident_flag = (rnd() < 0.32) ? "Yes" : "No";
      const incident = (incident_flag==="Yes") ? pick(FAILURE_MODES) : "None";

      const status = (within_sla==="No" && rnd()<0.60) ? "Overdue"
                   : (rnd()<0.60) ? "Completed"
                   : (rnd()<0.88) ? "In Progress"
                   : "Scheduled";

      DATA.work_orders.push({
        wo_id, date,
        client_id: client.client_id,
        client_name: client.name,
        industry: client.industry,
        site: asset ? asset.location : pick(SITES),
        system: sys.key,
        priority: pr.p,
        status,
        incident,
        sla_hours,
        within_sla,
        assigned_tech: tech.name,
        tech_id: tech.tech_id,
        asset_id: asset ? asset.asset_id : ""
      });

      // SAP chain
      const notif = "N-" + pad(i, 6);
      const so = "SO-" + pad(i, 6);
      const conf = "C-" + pad(i, 6);

      DATA.notifications.push({
        notif_id: notif,
        created_on: date,
        client_id: client.client_id,
        system: sys.key,
        priority: pr.p,
        asset_id: asset ? asset.asset_id : "",
        short_text: (incident!=="None") ? incident : (sys.short + " service request")
      });

      DATA.service_orders.push({
        service_order_id: so,
        notif_id: notif,
        start_date: date,
        planned_finish: addDays(date, Math.max(0, Math.floor(rnd()*3))),
        sla_hours,
        tech_id: tech.tech_id,
        status: (status==="Completed") ? "TECO" : "REL"
      });

      const labor_h = Math.max(1, Math.round(1 + rnd()*4 + (pr.p==="P1"?2:0)));
      DATA.confirmations.push({
        confirmation_id: conf,
        service_order_id: so,
        tech_id: tech.tech_id,
        confirmed_on: (status==="Completed") ? addDays(date, Math.max(0, Math.floor(rnd()*3))) : "",
        labor_hours: labor_h,
        final_status: (status==="Completed") ? "Completed" : "Open"
      });
    }

    renderAll();
  }

  function computeKPIs(){
    const wo = DATA.work_orders;
    const total = wo.length || 1;
    const completed = wo.filter(x => x.status === "Completed").length;
    const within = wo.filter(x => x.within_sla === "Yes").length;
    const overdue = wo.filter(x => x.status === "Overdue" || x.within_sla === "No").length;
    const avgSla = wo.length ? (wo.reduce((a,x)=>a + (+x.sla_hours||0), 0) / wo.length) : 0;
    return { total, completed, withinPct: within/total, overduePct: overdue/total, completionPct: completed/total, avgSla };
  }

  function applySearchFilter(rows){
    const q = ($("search").value || "").trim().toLowerCase();
    if(!q) return rows;
    return rows.filter(r => {
      const hay = [
        r.wo_id, r.date, r.client_name, r.site, r.system, r.priority,
        r.status, r.incident, r.assigned_tech, r.tech_id, r.within_sla
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function renderKpiCards(){
    const k = computeKPIs();
    $("kpiGrid").innerHTML = `
      <div class="kpi"><div><div class="k">Work orders</div><div class="v">${k.total}</div></div><span class="chip">Total</span></div>
      <div class="kpi"><div><div class="k">Completed</div><div class="v">${Math.round(k.completionPct*100)}%</div></div><span class="chip blue">Done</span></div>
      <div class="kpi"><div><div class="k">Avg SLA (hrs)</div><div class="v">${k.avgSla.toFixed(1)}</div></div><span class="chip">Hours</span></div>
      <div class="kpi"><div><div class="k">Overdue / breached</div><div class="v">${Math.round(k.overduePct*100)}%</div></div><span class="chip red">Risk</span></div>
    `;
  }

  function renderTable(){
    let rows = DATA.work_orders.slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
    if (showOverdueOnly) rows = rows.filter(x => x.within_sla === "No" || x.status === "Overdue");
    rows = applySearchFilter(rows);

    const body = $("tbody");
    body.innerHTML = "";
    rows.slice(0, 240).forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.wo_id}</td><td>${x.date}</td><td>${x.client_name}</td><td>${x.site}</td>
        <td>${x.system}</td><td>${x.priority}</td><td>${x.status}</td><td>${x.incident}</td>
        <td>${x.sla_hours}</td><td>${x.assigned_tech}</td><td>${x.within_sla}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderDonuts(){
    const k = computeKPIs();
    const grid = $("donutGrid");
    grid.innerHTML = "";
    grid.appendChild(donutCard("SLA Compliance", k.withinPct, "Within SLA", "rgba(37,99,235,1)", `${Math.round(k.withinPct*100)}% within SLA`));
    grid.appendChild(donutCard("Overdue Rate", k.overduePct, "Overdue", "rgba(239,68,68,1)", `${Math.round(k.overduePct*100)}% overdue/breached`));
    grid.appendChild(donutCard("Completion Rate", k.completionPct, "Completed", "rgba(15,23,42,.86)", `${Math.round(k.completionPct*100)}% completed`));
  }

  function buildTimeSeries(gran, metric){
    const map = new Map();
    for (const r of DATA.work_orders){
      const k = groupKey(r.date, gran);
      if (!map.has(k)) map.set(k, {key:k, total:0, within:0, overdue:0, completed:0});
      const o = map.get(k);
      o.total += 1;
      if (r.within_sla === "Yes") o.within += 1;
      if (r.status === "Overdue" || r.within_sla === "No") o.overdue += 1;
      if (r.status === "Completed") o.completed += 1;
    }
    const arr = Array.from(map.values()).sort((a,b)=>a.key.localeCompare(b.key));
    const labels = arr.map(x=>x.key);
    const values = arr.map(x=>{
      if (metric === "slaCompliance") return +(x.total ? (x.within/x.total*100) : 0).toFixed(1);
      if (metric === "overdueRate") return +(x.total ? (x.overdue/x.total*100) : 0).toFixed(1);
      if (metric === "completionRate") return +(x.total ? (x.completed/x.total*100) : 0).toFixed(1);
      return x.total;
    });
    return {labels, values};
  }

  function buildBar(metric){
    const map = new Map();

    if (metric === "workloadByTech"){
      for (const t of TECHS) map.set(t.name, 0);
      for (const r of DATA.work_orders) map.set(r.assigned_tech, (map.get(r.assigned_tech)||0) + 1);
      const labels = Array.from(map.keys());
      const values = labels.map(l => map.get(l));
      return {labels, values, label:"Work orders"};
    }

    if (metric === "overdueBySystem"){
      for (const s of SYSTEMS) map.set(s.key, 0);
      for (const r of DATA.work_orders){
        const isOver = (r.status === "Overdue" || r.within_sla === "No");
        if (isOver) map.set(r.system, (map.get(r.system)||0) + 1);
      }
      const labels = Array.from(map.keys());
      const values = labels.map(l => map.get(l));
      return {labels, values, label:"Overdue count"};
    }

    for (const s of SYSTEMS) map.set(s.key, 0);
    for (const r of DATA.work_orders){
      if (r.incident && r.incident !== "None") map.set(r.system, (map.get(r.system)||0) + 1);
    }
    const labels = Array.from(map.keys());
    const values = labels.map(l => map.get(l));
    return {labels, values, label:"Incidents count"};
  }

  function renderCharts(){
    const gran = $("gran").value;
    const trendMetric = $("trendMetric").value;
    const barMetric = $("barMetric").value;

    const ts = buildTimeSeries(gran, trendMetric);
    const b = buildBar(barMetric);

    if (trendChart) trendChart.destroy();
    trendChart = new Chart($("trendChart"), {
      type: "line",
      data: { labels: ts.labels, datasets: [{ label: trendMetric, data: ts.values, tension: 0.25, pointRadius: 2, borderWidth: 2 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: false } }
      }
    });

    if (barChart) barChart.destroy();
    barChart = new Chart($("barChart"), {
      type: "bar",
      data: { labels: b.labels, datasets: [{ label: b.label, data: b.values, borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
      }
    });
  }

  // Weekly SLA trend (extra)
  function buildWeeklySla(){
    const map = new Map();
    for (const r of DATA.work_orders){
      const key = r.date.slice(0,7); // month bucket for simplicity and stability
      if (!map.has(key)) map.set(key, {key, ok:0, total:0});
      const o = map.get(key);
      o.total += 1;
      if (r.within_sla === "Yes") o.ok += 1;
    }
    const arr = Array.from(map.values()).sort((a,b)=>a.key.localeCompare(b.key));
    return { labels: arr.map(x=>x.key), values: arr.map(x=> +(x.total?(x.ok/x.total*100):0).toFixed(1)) };
  }

  function renderWeeklyTrend(){
    const ts = buildWeeklySla();
    if (weeklyTrendChart) weeklyTrendChart.destroy();
    weeklyTrendChart = new Chart($("slaTrend"), {
      type: "line",
      data: { labels: ts.labels, datasets: [{ label:"SLA compliance (%)", data: ts.values, tension:0.25, pointRadius:2, borderWidth:2 }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:"index",intersect:false},
        plugins:{legend:{display:true}},
        scales:{x:{grid:{display:false}}, y:{beginAtZero:false}}
      }
    });
  }

  // Heatmap (System × Month)
  function drawHeatmap(){
    const c = $("slaHeatmap");
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    const systems = SYSTEMS.map(s=>s.key);
    const months = [...new Set(DATA.work_orders.map(w=>w.date.slice(0,7)))].sort().slice(-12); // last 12 months
    if (!months.length) return;

    // title area
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,c.width,c.height);

    const left = 180, top = 50;
    const cellW = Math.max(60, Math.floor((c.width - left - 40) / months.length));
    const cellH = 55;

    // labels
    ctx.fillStyle = "rgba(15,23,42,.75)";
    ctx.font = "900 12px system-ui";
    systems.forEach((s,i)=> ctx.fillText(s, 20, top + i*cellH + 32));

    ctx.save();
    ctx.translate(left, 20);
    ctx.font = "900 11px system-ui";
    ctx.fillStyle = "rgba(15,23,42,.65)";
    months.forEach((m,j)=>{
      ctx.save();
      ctx.translate(j*cellW + 6, 18);
      ctx.rotate(-0.4);
      ctx.fillText(m, 0, 0);
      ctx.restore();
    });
    ctx.restore();

    // cells
    systems.forEach((s,i)=>{
      months.forEach((m,j)=>{
        const rows = DATA.work_orders.filter(x=>x.system===s && x.date.startsWith(m));
        const ok = rows.filter(x=>x.within_sla==="Yes").length / (rows.length || 1);
        // map ok -> color (green-ish to red-ish)
        const r = Math.round(239 * (1-ok));
        const g = Math.round(180 * ok + 40);
        const b = 110;

        ctx.fillStyle = `rgb(${r},${g},${b})`;
        const x = left + j*cellW;
        const y = top + i*cellH;
        ctx.fillRect(x, y, cellW-8, cellH-10);

        ctx.fillStyle = "rgba(15,23,42,.9)";
        ctx.font = "900 12px system-ui";
        ctx.fillText(Math.round(ok*100) + "%", x + 10, y + 28);
      });
    });

    // legend
    ctx.fillStyle = "rgba(15,23,42,.75)";
    ctx.font = "900 12px system-ui";
    ctx.fillText("Heatmap legend: greener = stronger SLA compliance", 20, c.height - 18);
  }

  function downloadChartPng(chart, filename){
    if (!chart){ alert("Generate data first."); return; }
    const a = document.createElement("a");
    a.href = chart.toBase64Image("image/png", 1);
    a.download = filename;
    a.click();
  }

  function downloadCanvasPng(canvasId, filename){
    const c = $(canvasId);
    if (!c){ alert("Canvas not found."); return; }
    const a = document.createElement("a");
    a.href = c.toDataURL("image/png");
    a.download = filename;
    a.click();
  }

  function downloadPowerBIPack(){
    const technicians = TECHS.map(t => ({ tech_id:t.tech_id, technician:t.name, region:t.region, phone:t.phone }));
    const clients = CLIENTS.map(c => ({ client_id:c.client_id, client_name:c.name, industry:c.industry }));
    downloadCSV("powerbi_work_orders.csv", DATA.work_orders);
    downloadCSV("powerbi_assets.csv", DATA.assets);
    downloadCSV("powerbi_technicians.csv", technicians);
    downloadCSV("powerbi_clients.csv", clients);
  }

  function downloadSAPPack(){
    downloadCSV("sap_notifications.csv", DATA.notifications);
    downloadCSV("sap_service_orders.csv", DATA.service_orders);
    downloadCSV("sap_confirmations.csv", DATA.confirmations);
  }

  async function downloadPDFReport(){
    const k = computeKPIs();

    $("reportKpis").innerHTML = `
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Work orders</div>
        <div style="font-weight:950;font-size:18px">${k.total}</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">SLA compliance</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.withinPct*100)}%</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Overdue rate</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.overduePct*100)}%</div>
      </div>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px">
        <div style="font-weight:900;color:#64748b">Completion rate</div>
        <div style="font-weight:950;font-size:18px">${Math.round(k.completionPct*100)}%</div>
      </div>
    `;

    $("reportCharts").innerHTML = "";
    const chartImg1 = trendChart ? trendChart.toBase64Image("image/png", 1) : "";
    const chartImg2 = barChart ? barChart.toBase64Image("image/png", 1) : "";
    if (chartImg1){
      const img = document.createElement("img");
      img.src = chartImg1; img.style.width="100%";
      img.style.border="1px solid #e5e7eb"; img.style.borderRadius="12px";
      $("reportCharts").appendChild(img);
    }
    if (chartImg2){
      const img = document.createElement("img");
      img.src = chartImg2; img.style.width="100%";
      img.style.border="1px solid #e5e7eb"; img.style.borderRadius="12px";
      $("reportCharts").appendChild(img);
    }

    const area = $("reportArea");
    area.style.display="block";
    await new Promise(r=>setTimeout(r, 60));

    const canvas = await html2canvas(area, {scale:2, useCORS:true});
    const img = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const imgW = pageW - 48;
    const imgH = canvas.height * (imgW / canvas.width);

    if (imgH <= pageH - 48){
      pdf.addImage(img, "PNG", 24, 24, imgW, imgH);
    } else {
      let remaining = imgH;
      let srcY = 0;
      const sliceH = canvas.width * ((pageH - 48) / imgW);

      while (remaining > 0){
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = canvas.width;
        pageCanvas.height = Math.min(sliceH, canvas.height - srcY);
        const ctx = pageCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, srcY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);

        const pageImg = pageCanvas.toDataURL("image/png");
        const pageImgH = pageCanvas.height * (imgW / pageCanvas.width);

        pdf.addImage(pageImg, "PNG", 24, 24, imgW, pageImgH);
        remaining -= (pageH - 48);
        srcY += pageCanvas.height;
        if (remaining > 0) pdf.addPage();
      }
    }

    pdf.save("Convergint_Technical_Ops_Report.pdf");
    area.style.display="none";
  }

  function renderAll(){
    renderKpiCards();
    renderTable();
    renderDonuts();
    renderCharts();
    renderWeeklyTrend();
    drawHeatmap();
  }

  // Events
  $("btnGenerate").addEventListener("click", () => { showOverdueOnly=false; generate(); });
  $("btnOverdue").addEventListener("click", () => { showOverdueOnly=true; renderAll(); });
  $("btnAll").addEventListener("click", () => { showOverdueOnly=false; renderAll(); });
  $("search").addEventListener("input", renderTable);

  ["gran","trendMetric","barMetric"].forEach(id => $(id).addEventListener("change", renderCharts));
  $("dlTrendPng").addEventListener("click", ()=>downloadChartPng(trendChart, "Convergint_Trend.png"));
  $("dlBarPng").addEventListener("click", ()=>downloadChartPng(barChart, "Convergint_Bar.png"));
  $("dlSlaTrendPng").addEventListener("click", ()=>downloadChartPng(weeklyTrendChart, "Convergint_WeeklySLA.png"));
  $("dlHeatPng").addEventListener("click", ()=>downloadCanvasPng("slaHeatmap", "Convergint_SLA_Heatmap.png"));

  $("dlPB").addEventListener("click", downloadPowerBIPack);
  $("dlSAP").addEventListener("click", downloadSAPPack);
  $("btnPdf").addEventListener("click", downloadPDFReport);
  $("dlPDF2").addEventListener("click", downloadPDFReport);

  // Init
  generate();
</script>

</body>
</html>
